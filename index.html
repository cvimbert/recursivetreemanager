<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <script src="bower_components/requirejs/require.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div id="container" style="position: absolute; left: 400px; top: 400px; transform: scale(0.5)"></div>
<script>
    require(["recursivetreemanager", "pinit", "marionette", "jquery", "Draggable", "backbone"], function(RecursiveTreeManager, PinIt, Marionette, $, Draggable, Backbone) {

        var datas = {
            text: "1",
            id: "t0",
            ico_type: 2,
            settings: {
                //rotation: Math.PI / 4 * 3,
                angularMargin: 0.2,
                deployed: true
            },
            children: [
                {
                    text: "11",
                    id: "t4",
                    ico_type: 0,
                    settings: {

                    },
                    children: [
                        {
                            text: "111",
                            id: "t4-1",
                            ico_type: 1
                        },
                        {
                            text: "112",
                            id: "t4-2",
                            ico_type: 1
                        }
                    ]
                },
                {
                    text: "12",
                    id: "t3",
                    ico_type: 0,
                    settings: {

                    },
                    children: [
                        {
                            text: "121",
                            id: "t3-1",
                            ico_type: 1,
                            settings: {

                            },
                            children: []
                        },
                        {
                            text: "122",
                            id: "t3-2",
                            ico_type: 1,
                            settings: {

                            },
                            children: []
                        },
                        {
                            text: "123",
                            id: "t3-3",
                            ico_type: 1,
                            settings: {

                            },
                            children: []
                        }
                    ]
                },
                {
                    text: "14",
                    id: "t2",
                    ico_type: 0,
                    settings: {

                    },
                    children: [
                        {
                            text: "141",
                            id: "t2-1",
                            ico_type: 1
                        },
                        {
                            text: "142",
                            id: "t2-2",
                            ico_type: 1
                        }
                    ]
                },
                {
                    text: "15",
                    id: "t1",
                    ico_type: 0,
                    settings: {

                    }
                }
            ]
        };


        var TestModel = Backbone.Model.extend();

        var TestView = Marionette.ItemView.extend({
            template: function(serializedModel) {
                return _.template('<div class="elem" style="background-color: red; position: absolute; width: 50px; height: 50px"><%= text %></div>')(serializedModel);
            },
            events: {
                "click": "onClicked"
            },
            onClicked: function() {
                this.options.node.addChildAfter({
                    id: "yop",
                    text: "yyy"
                });
            },
            onRender: function() {
                Draggable.create($(".elem", this.$el));
            }
        });


        var pinIt = new PinIt({
            props: {
                x: 0,
                y: 0
            },
            bindings: {
                x: {
                    css: "x"
                },
                y: {
                    css: "y"
                }
            }
        });


        var views = {};


        function addNode(node) {
            var elem = $("<div></div>");
            $("#container").append(elem);

            var model = new TestModel(node.attributes);

            var view = new TestView({
                model: model,
                el: elem,
                node: node
            });

            view.render();
            views[node.attributes.id] = view;
        }


        function deleteNode(node) {

        }


        function addedFinished(nodes, manager) {

            manager.generateTreePositions();

            _.each(nodes, function(node) {
                var view = views[node.attributes.id];
                pinIt.bind(node.dynamicAttributes, $(".elem", view.$el));
            });
        }


        var treeManager = new RecursiveTreeManager({
            datas: datas,
            radiusList: [200, 200, 200],
            angularMargin: 0.2,
            nodeAdded: addNode,
            nodeDeleted: deleteNode,
            addedFinished: addedFinished
        });

        var nodes = treeManager.getNodesList();
    });
</script>
<div id="test" style="width: 40px; height: 40px; background-color: blue"></div>
</body>
</html>